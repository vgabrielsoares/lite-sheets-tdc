/**
 * VulnerabilityDie - Componente para gerenciar o Dado de Vulnerabilidade
 *
 * Sistema v0.0.2:
 * - Toda criatura começa com d20
 * - A cada Ataque Crítico recebido, rola o dado de vulnerabilidade
 * - Resultado = 1: Ferimento Crítico (PV → 0)
 * - Resultado ≥ 2: dado diminui um passo (d20 → d12 → d10 → d8 → d6 → d4)
 * - Reseta para d20 ao fim do combate ou ao sofrer Ferimento Crítico
 */
'use client';

import React, { useCallback, useState } from 'react';
import {
  Box,
  Card,
  CardContent,
  Typography,
  Button,
  Chip,
  Stack,
  Tooltip,
  IconButton,
} from '@mui/material';
import {
  Casino as DieIcon,
  RestartAlt as ResetIcon,
  Warning as WarningIcon,
  KeyboardArrowDown as StepDownIcon,
} from '@mui/icons-material';
import type {
  VulnerabilityDie as VulnerabilityDieType,
  VulnerabilityDieSize,
} from '@/types/combat';
import { VULNERABILITY_DIE_STEPS } from '@/types/combat';
import {
  stepDownVulnerabilityDie,
  resetVulnerabilityDie,
} from '@/utils/calculations';

export interface VulnerabilityDieProps {
  /** Estado atual do dado de vulnerabilidade */
  vulnerabilityDie: VulnerabilityDieType;
  /** Callback para atualizar o estado */
  onChange: (die: VulnerabilityDieType) => void;
}

/**
 * Labels para cada tamanho de dado
 */
const DIE_LABELS: Record<VulnerabilityDieSize, string> = {
  d20: 'D20',
  d12: 'D12',
  d10: 'D10',
  d8: 'D8',
  d6: 'D6',
  d4: 'D4',
};

/**
 * Cores para cada tamanho de dado (vai ficando mais vermelho conforme diminui)
 */
const DIE_COLORS: Record<
  VulnerabilityDieSize,
  'success' | 'info' | 'primary' | 'warning' | 'error' | 'error'
> = {
  d20: 'success',
  d12: 'info',
  d10: 'primary',
  d8: 'warning',
  d6: 'error',
  d4: 'error',
};

/**
 * Componente que exibe e gerencia o Dado de Vulnerabilidade
 */
export const VulnerabilityDie = React.memo(function VulnerabilityDie({
  vulnerabilityDie,
  onChange,
}: VulnerabilityDieProps) {
  const [lastRoll, setLastRoll] = useState<number | null>(null);
  const [lastRollResult, setLastRollResult] = useState<
    'step-down' | 'critical-wound' | null
  >(null);

  const { currentDie, isActive } = vulnerabilityDie;
  const currentIndex = VULNERABILITY_DIE_STEPS.indexOf(currentDie);
  const isMinimum = currentDie === 'd4';

  /**
   * Ativa o dado de vulnerabilidade (início de combate)
   */
  const handleActivate = useCallback(() => {
    onChange({ currentDie: 'd20', isActive: true });
    setLastRoll(null);
    setLastRollResult(null);
  }, [onChange]);

  /**
   * Desativa e reseta o dado (fim de combate)
   */
  const handleDeactivate = useCallback(() => {
    onChange({ currentDie: resetVulnerabilityDie(), isActive: false });
    setLastRoll(null);
    setLastRollResult(null);
  }, [onChange]);

  /**
   * Diminui o dado manualmente (sem rolagem — para controle direto)
   */
  const handleStepDown = useCallback(() => {
    const newDie = stepDownVulnerabilityDie(currentDie);
    onChange({ ...vulnerabilityDie, currentDie: newDie });
    setLastRoll(null);
    setLastRollResult(null);
  }, [currentDie, vulnerabilityDie, onChange]);

  /**
   * Reseta para d20 (Ferimento Crítico ou fim de combate)
   */
  const handleReset = useCallback(() => {
    onChange({ ...vulnerabilityDie, currentDie: resetVulnerabilityDie() });
    setLastRoll(null);
    setLastRollResult(null);
  }, [vulnerabilityDie, onChange]);

  return (
    <Card variant="outlined">
      <CardContent sx={{ p: 2, '&:last-child': { pb: 2 } }}>
        <Stack
          direction="row"
          alignItems="center"
          justifyContent="space-between"
          sx={{ mb: 1 }}
        >
          <Stack direction="row" alignItems="center" spacing={1}>
            <DieIcon color="warning" fontSize="small" />
            <Typography variant="subtitle2" fontWeight="bold">
              Dado de Vulnerabilidade
            </Typography>
          </Stack>

          {isActive ? (
            <Tooltip title="Finalizar combate (resetar dado)">
              <IconButton size="small" onClick={handleDeactivate}>
                <ResetIcon fontSize="small" />
              </IconButton>
            </Tooltip>
          ) : (
            <Button
              size="small"
              variant="outlined"
              onClick={handleActivate}
              startIcon={<DieIcon />}
              sx={{ textTransform: 'none' }}
            >
              Iniciar Combate
            </Button>
          )}
        </Stack>

        {isActive ? (
          <Box>
            {/* Dado atual */}
            <Stack
              direction="row"
              alignItems="center"
              spacing={2}
              sx={{ mb: 1.5 }}
            >
              <Chip
                label={DIE_LABELS[currentDie]}
                color={DIE_COLORS[currentDie]}
                variant="filled"
                sx={{ fontWeight: 'bold', fontSize: '1.1rem', minWidth: 60 }}
              />

              {/* Indicador visual da escala */}
              <Stack direction="row" spacing={0.5} alignItems="center">
                {VULNERABILITY_DIE_STEPS.map((die, index) => (
                  <Box
                    key={die}
                    sx={{
                      width: 8,
                      height: 8,
                      borderRadius: '50%',
                      bgcolor:
                        index <= currentIndex
                          ? `${DIE_COLORS[die]}.main`
                          : 'action.disabled',
                      transition: 'background-color 0.3s ease-in-out',
                    }}
                  />
                ))}
              </Stack>

              {isMinimum && (
                <Tooltip title="Dado no d4. Ao sofrer dano, role 1d4: resultado 1 = Ferimento Crítico.">
                  <WarningIcon color="error" fontSize="small" />
                </Tooltip>
              )}
            </Stack>

            {/* Botões de controle */}
            <Stack direction="row" spacing={1}>
              <Tooltip title="Reduzir dado (após Acerto Crítico recebido, resultado ≥ 2)">
                <span>
                  <Button
                    size="small"
                    variant="outlined"
                    color="warning"
                    onClick={handleStepDown}
                    disabled={isMinimum}
                    startIcon={<StepDownIcon />}
                    sx={{ textTransform: 'none' }}
                  >
                    Reduzir
                  </Button>
                </span>
              </Tooltip>

              <Tooltip title="Resetar para D20 (Ferimento Crítico ou efeito especial)">
                <Button
                  size="small"
                  variant="outlined"
                  color="info"
                  onClick={handleReset}
                  disabled={currentDie === 'd20'}
                  startIcon={<ResetIcon />}
                  sx={{ textTransform: 'none' }}
                >
                  Resetar
                </Button>
              </Tooltip>
            </Stack>

            {/* Resultado da última rolagem */}
            {lastRoll !== null && (
              <Typography
                variant="caption"
                color={
                  lastRollResult === 'critical-wound'
                    ? 'error'
                    : 'text.secondary'
                }
                sx={{ mt: 1, display: 'block' }}
              >
                Última rolagem: {lastRoll}
                {lastRollResult === 'critical-wound' && ' — Ferimento Crítico!'}
                {lastRollResult === 'step-down' && ` — Dado reduzido`}
              </Typography>
            )}
          </Box>
        ) : (
          <Typography variant="body2" color="text.secondary">
            Fora de combate. O dado reseta para D20 automaticamente.
          </Typography>
        )}
      </CardContent>
    </Card>
  );
});
